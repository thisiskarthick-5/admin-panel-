<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <!-- Google Fonts Import for Roboto -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Three.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <!-- CSS styles -->
    <style>
        :root {
            --firebase-amber: #ffab00;
            --firebase-amber-dark: #e69a00;
            --background-dark: #202124; 
            --surface-dark: #303134;   
            --text-primary-light: #ffffff;
            --text-secondary-light: #bdc1c6;
            --border-color-dark: #5f6368;
            --danger-color: #e57373; 
            --info-color: #64b5f6; /* Color for Edit button */
            --font-family-main: "Roboto", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }

        /* ===== Universal Box Sizing & Reset ===== */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        /* --- General Body & Font Styles --- */
        body {
            font-family: var(--font-family-main);
            background-color: var(--background-dark);
            display: flex;
            height: 100vh;
            overflow: hidden;
            color: var(--text-primary-light);
            font-size: 16px;
        }
        
        /* --- Preloader & Front Page --- */
        #preloader { position: fixed; left: 0; top: 0; z-index: 9999; width: 100%; height: 100%; overflow: visible; background: var(--background-dark); display: flex; justify-content: center; align-items: center; }
        .loader { border: 5px solid var(--surface-dark); border-top: 5px solid var(--firebase-amber); border-radius: 50%; width: 60px; height: 60px; animation: spin 1.5s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #frontPage { position: fixed; left: 0; top: 0; z-index: 9990; width: 100%; height: 100%; background: var(--background-dark); color: var(--text-primary-light); display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; transition: opacity 0.8s ease-out; overflow: hidden; padding: 1rem; }
        #three-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        #frontPage h1, #frontPage p, #frontPage #enterDashboardBtn { position: relative; z-index: 2; margin-bottom: 1.5rem; }
        #frontPage h1 { font-size: 5.5rem; }
        #frontPage p { font-size: 1.5rem; max-width: 600px; color: var(--text-secondary-light); margin-bottom: 3rem; }
        @keyframes slide-in-down { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes slide-in-up { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        #enterDashboardBtn { padding: 1rem 2.5rem; font-size: 1.2rem; font-weight: 500; color: var(--background-dark); background-color: var(--firebase-amber); border: none; border-radius: 8px; cursor: pointer; transition: transform 0.2s, background-color 0.3s; }
        #enterDashboardBtn:hover { transform: scale(1.05); background-color: var(--firebase-amber-dark); }

        /* --- Sidebar --- */
        .sidebar { width: 250px; flex-shrink: 0; background-color: var(--surface-dark); color: var(--text-primary-light); display: flex; flex-direction: column; border-right: 1px solid var(--border-color-dark); transition: transform 0.3s ease-in-out; }
        .sidebar-header { padding: 1.5rem; font-weight: 700; font-size: 1.5rem; color: var(--text-primary-light); border-bottom: 1px solid var(--border-color-dark); }
        .sidebar-section-title { text-transform: uppercase; font-size: 0.8rem; font-weight: 500; padding: 2rem 1.5rem 0.75rem; color: var(--text-secondary-light); }
        .sidebar ul { list-style: none; }
        .sidebar a { display: block; color: var(--text-secondary-light); text-decoration: none; padding: 0.8rem 1.5rem; margin: 0 1rem 0.25rem; border-radius: 6px; font-weight: 500; transition: background-color 0.2s, color 0.2s; cursor: pointer; }
        .sidebar a:hover { background-color: rgba(255, 171, 0, 0.1); color: var(--firebase-amber); }
        .sidebar a.active { background-color: var(--firebase-amber); color: var(--background-dark); font-weight: 700; }

        /* --- Main Content & Header (UPDATED) --- */
        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Important for containing children */
            min-width: 0; /* THE MOST CRITICAL FIX FOR FLEXBOX OVERFLOW */
        }
        .content-header { background-color: var(--surface-dark); padding: 1rem 2rem; border-bottom: 1px solid var(--border-color-dark); flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; }
        .content-header h1 { font-size: 2rem; font-weight: 500; }

        /* --- Action Bar --- */
        .action-bar { display: flex; align-items: center; gap: 1.5rem; padding: 1.5rem 2rem; background-color: var(--background-dark); border-bottom: 1px solid var(--border-color-dark); flex-wrap: wrap; }
        .action-bar input { padding: 0.75rem 1rem; border: 1px solid var(--border-color-dark); border-radius: 8px; font-size: 1rem; background-color: var(--surface-dark); color: var(--text-primary-light); transition: border-color 0.3s, box-shadow 0.3s; flex-grow: 1; min-width: 200px; }
        .action-bar input:focus { outline: none; border-color: var(--firebase-amber); box-shadow: 0 0 0 2px rgba(255, 171, 0, 0.3); }
        .action-bar-right-group { display: flex; align-items: center; gap: 1rem; margin-left: auto; }
        .count-badge { background-color: var(--surface-dark); padding: 0.5rem 1rem; border-radius: 8px; font-weight: 500; border: 1px solid var(--border-color-dark); white-space: nowrap; }
        .count-badge span { font-weight: 700; color: var(--firebase-amber); }
        .btn-primary { background-color: var(--firebase-amber); color: var(--background-dark); border: none; padding: 0.8rem 1.5rem; border-radius: 8px; font-weight: 700; font-size: 1rem; cursor: pointer; transition: background-color 0.2s, transform 0.2s; white-space: nowrap; }
        .btn-primary:hover { background-color: var(--firebase-amber-dark); transform: translateY(-1px); }
        .btn-primary:disabled { background-color: var(--border-color-dark); cursor: not-allowed; transform: none; }

        /* --- Table Container & Styling (UPDATED) --- */
        .table-container { 
            flex-grow: 1; 
            overflow-x: auto; /* THIS IS KEY: Allows table to be scrolled horizontally */
            padding: 0 2rem 2rem 2rem; 
        }
        table { width: 100%; border-collapse: collapse; background-color: var(--surface-dark); border-radius: 12px; overflow: hidden; }
        th, td { padding: 1.25rem 1.5rem; text-align: left; border-bottom: 1px solid var(--border-color-dark); white-space: nowrap; }
        thead th { font-size: 0.85rem; text-transform: uppercase; color: var(--text-secondary-light); font-weight: 500; background-color: #3c4043; }
        tbody tr { transition: background-color 0.2s; }
        tbody tr:hover { background-color: #3c4043; }
        tbody tr:last-child td { border-bottom: none; }

        .action-buttons { display: flex; gap: 0.5rem; } 
        .btn-edit { background-color: transparent; color: var(--info-color); border: 1px solid transparent; padding: 0.4rem 0.8rem; font-size: 0.9rem; border-radius: 6px; cursor: pointer; font-weight: 500; transition: background-color 0.2s, border-color 0.2s; }
        .btn-edit:hover { background-color: rgba(100, 181, 246, 0.1); border-color: var(--info-color); }

        .btn-delete { background-color: transparent; color: var(--danger-color); border: 1px solid transparent; padding: 0.4rem 0.8rem; font-size: 0.9rem; border-radius: 6px; cursor: pointer; font-weight: 500; transition: background-color 0.2s, border-color 0.2s; }
        .btn-delete:hover { background-color: rgba(229, 115, 115, 0.1); border-color: var(--danger-color); }
        
        /* --- Management Views --- */
        .management-view { display: none; height: 100%; flex-direction: column; }
        .management-view.active { display: flex; }

        /* --- Animated Modal --- */
        .modal { 
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.7); 
            justify-content: center; 
            align-items: flex-start;
            padding: 5vh 1rem;
        }
        .modal-content {
            background-color: var(--surface-dark); padding: 2.5rem; border-radius: 12px; width: 100%; 
            max-width: 500px; 
            animation: modal-fade-in 0.4s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid var(--border-color-dark);
            margin-bottom: 5vh;
        }
        @keyframes modal-fade-in { from { opacity: 0; transform: scale(0.9) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color-dark); padding-bottom: 1.5rem; margin-bottom: 2rem; }
        .modal-header h2 { font-size: 1.8rem; font-weight: 500; }
        .close-btn { font-size: 2rem; cursor: pointer; color: var(--text-secondary-light); transition: color 0.2s, transform 0.3s; }
        .close-btn:hover { color: var(--text-primary-light); transform: rotate(90deg); }
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.75rem; font-weight: 500; font-size: 1.1rem; color: var(--text-primary-light); }
        .form-group input, .form-group select { width: 100%; padding: 0.8rem 1rem; border: 1px solid var(--border-color-dark); background-color: var(--background-dark); color: var(--text-primary-light); border-radius: 8px; font-size: 1rem; transition: border-color 0.3s, box-shadow 0.3s; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--firebase-amber); box-shadow: 0 0 0 2px rgba(255, 171, 0, 0.3); }
        .modal-footer { margin-top: 2rem; text-align: right; }

        /* --- Checkbox Styling --- */
        .form-group-checkbox { display: flex; align-items: center; gap: 0.75rem; }
        .form-group-checkbox input[type="checkbox"] { width: 1.25em; height: 1.25em; cursor: pointer; accent-color: var(--firebase-amber); }

        /* --- Toast Notification Styles --- */
        #toastContainer { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; align-items: center; gap: 10px; width: 90%; max-width: 500px; }
        .toast { padding: 12px 20px; border-radius: 8px; font-weight: 500; color: var(--text-primary-light); box-shadow: 0 4px 12px rgba(0,0,0,0.2); animation: slide-in 0.3s ease-out, fade-out 0.5s ease-in 3.5s forwards; }
        .toast.error { background-color: var(--danger-color); }
        .toast.success { background-color: #4caf50; } 
        @keyframes slide-in { from { transform: translateY(-100px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fade-out { from { opacity: 1; } to { opacity: 0; transform: translateY(-20px); } }

        /* --- Responsive Design (UPDATED) --- */
        .menu-btn { display: none; background: none; border: none; font-size: 2rem; cursor: pointer; color: var(--text-primary-light); }
        @media (max-width: 768px) {
            body { font-size: 14px; }
            #frontPage h1 { font-size: 3rem; }
            #frontPage p { font-size: 1.1rem; }
            .sidebar { position: fixed; left: 0; top: 0; height: 100%; z-index: 1000; transform: translateX(-100%); }
            .sidebar.show { transform: translateX(0); }
            .main-content { width: 100%; }
            .content-header h1 { font-size: 1.5rem; }
            .menu-btn { display: block; }
            
            /* Better padding on mobile */
            .content-header, .action-bar { padding: 1rem 1rem; }
            .table-container { padding: 0 1rem 1rem 1rem; }
            
            /* Action bar stacking */
            .action-bar { flex-direction: column; align-items: stretch; gap: 1rem; }
            .action-bar-right-group { margin-left: 0; margin-top: 0.5rem; width: 100%; justify-content: space-between; }
            
            /* CRITICAL: Reduce table cell padding and font size to prevent overflow */
            th, td {
                padding: 0.8rem 0.5rem;
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body>
    <div id="toastContainer"></div>
    <div id="preloader"><div class="loader"></div></div>

    <div id="frontPage">
        <canvas id="three-bg"></canvas>
        <h1>Admin Dashboard</h1>
        <p>Manage your store's categories, subcategories, and products with ease.</p>
        <button id="enterDashboardBtn">Get Started</button>
    </div>

    <!-- Left Sidebar Navigation -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">Admin Panel</div>
        <div class="sidebar-section-title">Store Management</div>
        <ul>
            <li><a id="navCategory" data-view="categoryView" class="active">Category</a></li>
            <li><a id="navSubcategory" data-view="subcategoryView">Subcategory</a></li>
            <li><a id="navProduct" data-view="productView">Product</a></li>
        </ul>
    </nav>

    <!-- Main Content Area -->
    <main class="main-content">
        <header class="content-header">
            <button class="menu-btn" id="menuBtn">&#9776;</button>
            <h1 id="mainHeader">Category Management</h1>
        </header>

        <!-- CATEGORY VIEW -->
        <div id="categoryView" class="management-view active">
            <div class="action-bar">
                <input type="text" class="filter-input" placeholder="Search by name or ID...">
                <div class="action-bar-right-group">
                    <div class="count-badge">Categories: <span id="categoryCount">0</span></div>
                    <button class="btn-primary open-modal-btn" data-modal="categoryModal">ADD CATEGORY</button>
                </div>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Category ID</th>
                            <th>Category Name (Eng)</th>
                            <th>Category Name (Tamil)</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody class="data-table-body">
                        <!-- Data will be injected here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- SUBCATEGORY VIEW -->
        <div id="subcategoryView" class="management-view">
            <div class="action-bar">
                <input type="text" class="filter-input" placeholder="Search by name or ID...">
                 <div class="action-bar-right-group">
                    <div class="count-badge">Subcategories: <span id="subcategoryCount">0</span></div>
                    <!-- MODIFIED: Added ID for JS targeting -->
                    <button id="addSubcategoryBtn" class="btn-primary open-modal-btn" data-modal="subcategoryModal" disabled>ADD SUBCATEGORY</button>
                </div>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Parent Category</th>
                            <th>Subcategory ID</th>
                            <th>Subcategory Name (Eng)</th>
                            <th>Subcategory Name (Tamil)</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody class="data-table-body">
                         <!-- Data will be injected here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- PRODUCT VIEW -->
        <div id="productView" class="management-view">
            <div class="action-bar">
                <input type="text" class="filter-input" placeholder="Search by name or ID...">
                <div class="action-bar-right-group">
                    <div class="count-badge">Products: <span id="productCount">0</span></div>
                    <!-- MODIFIED: Added ID for JS targeting -->
                    <button id="addProductBtn" class="btn-primary open-modal-btn" data-modal="productModal" disabled>ADD PRODUCT</button>
                </div>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Subcategory</th>
                            <th>Product ID</th>
                            <th>Product Name (Eng)</th>
                            <th>Product Name (Tamil)</th>
                            <th>Rate</th>
                            <th>Top Product</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody class="data-table-body">
                         <!-- Data will be injected here -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>
    
    <!-- MODALS -->
    <div id="categoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add New Category</h2>
                <span class="close-btn">&times;</span>
            </div>
            <form class="modal-form" data-collection="categories">
                <input type="hidden" name="editId">
                <input type="hidden" name="originalCatId">
                <input type="hidden" name="originalCatNameEng">
                <div class="form-group">
                    <label for="catId">Category ID</label>
                    <input type="text" id="catId" name="catId" required>
                </div>
                <div class="form-group">
                    <label for="catNameEng">Category Name (Eng)</label>
                    <input type="text" id="catNameEng" name="catNameEng" required>
                </div>
                <div class="form-group">
                    <label for="catNameTam">Category Name (Tamil)</label>
                    <input type="text" id="catNameTam" name="catNameTam" required>
                </div>
                <div class="form-group">
                    <label for="catImage">Image URL</label>
                    <input type="url" id="catImage" name="catImage" required>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn-primary modal-submit-btn">Add Category</button>
                </div>
            </form>
        </div>
    </div>
    <div id="subcategoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add New Subcategory</h2>
                <span class="close-btn">&times;</span>
            </div>
            <form class="modal-form" data-collection="subcategories">
                <input type="hidden" name="editId">
                <input type="hidden" name="originalSubcatId">
                <input type="hidden" name="originalSubcatNameEng">
                <input type="hidden" name="parentCatId"> <!-- To store the original parent ID for update path -->
                <div class="form-group">
                    <label for="parentCategoryId">Parent Category</label>
                    <select id="parentCategoryId" name="parentCategoryId" required>
                        <option value="" disabled selected>Select a category</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="subcatId">Subcategory ID</label>
                    <input type="text" id="subcatId" name="subcatId" required>
                </div>
                <div class="form-group">
                    <label for="subcatNameEng">Subcategory Name (Eng)</label>
                    <input type="text" id="subcatNameEng" name="subcatNameEng" required>
                </div>
                <div class="form-group">
                    <label for="subcatNameTam">Subcategory Name (Tamil)</label>
                    <input type="text" id="subcatNameTam" name="subcatNameTam" required>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn-primary modal-submit-btn">Add Subcategory</button>
                </div>
            </form>
        </div>
    </div>
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add New Product</h2>
                <span class="close-btn">&times;</span>
            </div>
            <form class="modal-form" data-collection="products">
                <input type="hidden" name="editId">
                <input type="hidden" name="originalProdId">
                <input type="hidden" name="originalProdNameEng">
                <div class="form-group">
                    <label for="prodCategory">Category</label>
                    <select id="prodCategory" name="prodCategoryId" required>
                        <option value="" disabled selected>Select a category</option>
                    </select>
                </div>
                 <div class="form-group">
                    <label for="prodSubCategory">Sub-Category</label>
                    <!-- MODIFIED: Removed the 'required' attribute to make subcategory optional -->
                    <select id="prodSubCategory" name="prodSubCategoryId">
                        <option value="" disabled selected>Select a sub-category</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="prodId">Product ID</label>
                    <input type="text" id="prodId" name="prodId" required>
                </div>
                <div class="form-group">
                    <label for="prodNameEng">Product Name (Eng)</label>
                    <input type="text" id="prodNameEng" name="prodNameEng" required>
                </div>
                 <div class="form-group">
                    <label for="prodNameTam">Product Name (Tamil)</label>
                    <input type="text" id="prodNameTam" name="prodNameTam" required>
                </div>
                <div class="form-group">
                    <label for="prodRate">Rate</label>
                    <input type="number" id="prodRate" name="prodRate" required>
                </div>
                <div class="form-group form-group-checkbox">
                    <label for="isTopProduct">Top Product</label>
                    <input type="checkbox" id="isTopProduct" name="isTopProduct">
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn-primary modal-submit-btn">Save Product</button>
                </div>
            </form>
        </div>
    </div>
<script type="module">
    // Import only Realtime Database modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { 
        getDatabase, 
        ref, 
        push,
        set,
        update,
        remove,
        onValue,
        get, 
        query,
        orderByChild
    } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

    // Your Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyD-4hqIpRkEDA89ob2p4N89-C9b6Wl7-vk",
        authDomain: "product-handling.firebaseapp.com",
        databaseURL: "https://product-handling-default-rtdb.firebaseio.com/",
        projectId: "product-handling",
        storageBucket: "product-handling.appspot.com",
        messagingSenderId: "229189990697",
        appId: "1:229189990697:web:79227c24a9268d98ef9f38",
        measurementId: "G-XKE5MX83H6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- GLOBAL STATE & DOM Elements ---
    let allData = { categories: [], subcategories: [], products: [] };
    let categoryMap = {};
    let subcategoryMap = {};

    const mainHeader = document.getElementById('mainHeader');

    // --- VIEW SWITCHING ---
    document.querySelectorAll('.sidebar a').forEach(link => {
        link.addEventListener('click', () => {
            document.querySelector('.sidebar a.active').classList.remove('active');
            link.classList.add('active');
            
            document.querySelector('.management-view.active').classList.remove('active');
            document.getElementById(link.dataset.view).classList.add('active');
            
            mainHeader.textContent = `${link.textContent} Management`;
        });
    });

    // --- MODAL HANDLING ---
    const resetModal = (modal) => {
        const form = modal.querySelector('.modal-form');
        form.reset();
        form.querySelector('input[name="editId"]').value = '';
        form.querySelectorAll('input[type="hidden"]').forEach(input => {
            if (input.name.startsWith('original') || input.name === 'parentCatId') {
                input.value = '';
            }
        });
        modal.querySelector('.modal-title').textContent = `Add New ${modal.id.replace('Modal', '').replace(/([A-Z])/g, ' $1').trim()}`;
        modal.querySelector('.modal-submit-btn').textContent = `Add ${modal.id.replace('Modal', '').replace(/([A-Z])/g, ' $1').trim()}`;
        if (modal.id === 'subcategoryModal' || modal.id === 'productModal') populateCategoryDropdowns();
        if (modal.id === 'productModal') document.getElementById('prodSubCategory').innerHTML = '<option value="" disabled selected>Select a sub-category</option>';
        const submitButton = form.querySelector('.modal-submit-btn');
        if (submitButton) submitButton.disabled = false;
    };

    document.querySelectorAll('.open-modal-btn').forEach(button => {
        button.addEventListener('click', () => {
            const modal = document.getElementById(button.dataset.modal);
            resetModal(modal);
            modal.style.display = 'flex';
        });
    });

    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal') || e.target.classList.contains('close-btn')) {
                modal.style.display = 'none';
                resetModal(modal);
            }
        });
    });

    // --- DATA RENDERING ---
    const renderCategories = (data) => {
        const tableBody = document.querySelector('#categoryView .data-table-body');
        tableBody.innerHTML = '';
        data.forEach(item => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${item.catId || ''}</td>
                <td>${item.catNameEng || ''}</td>
                <td>${item.catNameTam || ''}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn-edit" data-id="${item.id}" data-collection="categories">Edit</button>
                        <button class="btn-delete" data-id="${item.id}" data-collection="categories">Delete</button>
                    </div>
                </td>
            `;
            tableBody.appendChild(row);
        });
    };

    const renderSubcategories = (data) => {
        const tableBody = document.querySelector('#subcategoryView .data-table-body');
        tableBody.innerHTML = '';
        data.forEach(item => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${categoryMap[item.parentCategoryId] || 'N/A'}</td>
                <td>${item.subcatId || ''}</td>
                <td>${item.subcatNameEng || ''}</td>
                <td>${item.subcatNameTam || ''}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn-edit" data-id="${item.id}" data-collection="subcategories">Edit</button>
                        <button class="btn-delete" data-id="${item.id}" data-parent-id="${item.parentCategoryId}" data-collection="subcategories">Delete</button>
                    </div>
                </td>
            `;
            tableBody.appendChild(row);
        });
    };

    const renderProducts = (data) => {
        const tableBody = document.querySelector('#productView .data-table-body');
        tableBody.innerHTML = '';
        data.forEach(item => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${categoryMap[item.prodCategoryId] || 'N/A'}</td>
                <td>${subcategoryMap[item.prodSubCategoryId] || 'N/A'}</td>
                <td>${item.prodId || ''}</td>
                <td>${item.prodNameEng || ''}</td>
                <td>${item.prodNameTam || ''}</td>
                <td>₹${item.prodRate || 0}</td>
                <td>${item.isTopProduct ? 'Yes' : 'No'}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn-edit" data-id="${item.id}" data-collection="products">Edit</button>
                        <button class="btn-delete" data-id="${item.id}" data-collection="products">Delete</button>
                    </div>
                </td>
            `;
            tableBody.appendChild(row);
        });
    };
    
    // --- UI STATE MANAGEMENT ---
    const updateButtonStates = () => {
        const addSubcategoryBtn = document.getElementById('addSubcategoryBtn');
        const addProductBtn = document.getElementById('addProductBtn');
        const categoriesExist = allData.categories.length > 0;

        addSubcategoryBtn.disabled = !categoriesExist;
        addSubcategoryBtn.title = categoriesExist
            ? 'Add a new subcategory'
            : 'Please create a category first before adding a subcategory.';

        addProductBtn.disabled = !categoriesExist;
        addProductBtn.title = categoriesExist
            ? 'Add a new product'
            : 'Please create a category first before adding a product.';
    };

    // --- DATA FETCHING ---
    onValue(query(ref(db, 'categories'), orderByChild('catNameEng')), (snapshot) => {
        const categories = [];
        const subcategoriesFlattened = [];
        categoryMap = {};
        snapshot.forEach(childSnapshot => {
            const categoryData = childSnapshot.val();
            if (categoryData) {
                const categoryId = childSnapshot.key;
                const category = { id: categoryId, ...categoryData };
                categories.push(category);
                categoryMap[categoryId] = category.catNameEng;

                if (categoryData.subcategories) {
                    Object.keys(categoryData.subcategories).forEach(subcatId => {
                        subcategoriesFlattened.push({
                            id: subcatId,
                            parentCategoryId: categoryId,
                            ...categoryData.subcategories[subcatId]
                        });
                    });
                }
            }
        });
        allData.categories = categories;
        allData.subcategories = subcategoriesFlattened;
        
        subcategoryMap = allData.subcategories.reduce((map, subcat) => {
            map[subcat.id] = subcat.subcatNameEng;
            return map;
        }, {});

        document.getElementById('categoryCount').textContent = allData.categories.length;
        document.getElementById('subcategoryCount').textContent = allData.subcategories.length;
        renderCategories(allData.categories);
        renderSubcategories(allData.subcategories);
        populateCategoryDropdowns();
        updateButtonStates();
    }, console.error);

    onValue(query(ref(db, 'products'), orderByChild('prodNameEng')), (snapshot) => {
        const products = [];
        snapshot.forEach(childSnapshot => {
            if (childSnapshot.val()) {
                products.push({ id: childSnapshot.key, ...childSnapshot.val() });
            }
        });
        allData.products = products;
        document.getElementById('productCount').textContent = products.length;
        renderProducts(allData.products);
    }, console.error);

    // --- DYNAMIC DROPDOWNS ---
    const populateCategoryDropdowns = () => {
        [document.getElementById('parentCategoryId'), document.getElementById('prodCategory')].forEach(dropdown => {
            const currentValue = dropdown.value;
            dropdown.innerHTML = '<option value="" disabled selected>Select a category</option>';
            allData.categories.forEach(cat => {
                dropdown.innerHTML += `<option value="${cat.id}">${cat.catNameEng}</option>`;
            });
            dropdown.value = currentValue;
        });
    };

    const populateSubcategoryDropdown = (categoryId, targetDropdownId, selectedSubcatId = null) => {
        const subcatDropdown = document.getElementById(targetDropdownId);
        subcatDropdown.innerHTML = '<option value="">(None)</option>';
        if (categoryId) {
            allData.subcategories
                .filter(sub => sub.parentCategoryId === categoryId)
                .forEach(subcat => {
                    subcatDropdown.innerHTML += `<option value="${subcat.id}">${subcat.subcatNameEng}</option>`;
                });
        }
        if (selectedSubcatId) subcatDropdown.value = selectedSubcatId;
    };

    document.getElementById('prodCategory').addEventListener('change', (e) => {
        populateSubcategoryDropdown(e.target.value, 'prodSubCategory');
    });

    // --- Toast Notification ---
    const showToast = (message, type = 'success') => {
        const toastContainer = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        toastContainer.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
    };

    // --- REAL-TIME VALIDATION LOGIC ---
    const validateCategoryInput = (event) => {
        const input = event.target;
        const value = input.value.trim().toLowerCase();
        const form = input.form;
        const submitButton = form.querySelector('.modal-submit-btn');
        const isEditMode = form.editId.value !== '';

        if (isEditMode) return;
        if (!value) {
            submitButton.disabled = false;
            return;
        }

        const property = input.name === 'catId' ? 'catId' : 'catNameEng';
        const isDuplicate = allData.categories.some(cat => cat[property].toLowerCase() === value);

        if (isDuplicate) {
            showToast(`Error: ${input.labels[0].textContent} already exists.`, 'error');
            submitButton.disabled = true;
        } else {
            submitButton.disabled = false;
        }
    };
    
    const validateSubcategoryInput = () => {
        const form = document.getElementById('subcategoryModal').querySelector('form');
        const parentId = document.getElementById('parentCategoryId').value;
        const subcatIdInput = document.getElementById('subcatId');
        const subcatNameInput = document.getElementById('subcatNameEng');
        const submitButton = form.querySelector('.modal-submit-btn');
        const isEditMode = form.editId.value !== '';

        if (isEditMode) return;
        if (!parentId) {
            submitButton.disabled = false; 
            return;
        }

        const subcatIdValue = subcatIdInput.value.trim().toLowerCase();
        const subcatNameValue = subcatNameInput.value.trim().toLowerCase();
        const subcategoriesInParent = allData.subcategories.filter(sub => sub.parentCategoryId === parentId);

        let idIsDuplicate = subcatIdValue ? subcategoriesInParent.some(sub => sub.subcatId.toLowerCase() === subcatIdValue) : false;
        let nameIsDuplicate = subcatNameValue ? subcategoriesInParent.some(sub => sub.subcatNameEng.toLowerCase() === subcatNameValue) : false;

        if (idIsDuplicate) {
            showToast(`Error: Subcategory ID already exists in this parent category.`, 'error');
            submitButton.disabled = true;
        } else if (nameIsDuplicate) {
            showToast(`Error: Subcategory Name already exists in this parent category.`, 'error');
            submitButton.disabled = true;
        } else {
            submitButton.disabled = false;
        }
    };
    
    const validateProductInput = (event) => {
        const input = event.target;
        const value = input.value.trim().toLowerCase();
        const form = input.form;
        const submitButton = form.querySelector('.modal-submit-btn');
        const isEditMode = form.editId.value !== '';

        if (isEditMode) return;
        if (!value) {
            submitButton.disabled = false;
            return;
        }

        const property = input.name === 'prodId' ? 'prodId' : 'prodNameEng';
        const isDuplicate = allData.products.some(prod => prod[property].toLowerCase() === value);

        if (isDuplicate) {
            showToast(`Error: ${input.labels[0].textContent} already exists.`, 'error');
            submitButton.disabled = true;
        } else {
            submitButton.disabled = false;
        }
    };

    // Attach real-time validation listeners
    document.getElementById('catId').addEventListener('input', validateCategoryInput);
    document.getElementById('catNameEng').addEventListener('input', validateCategoryInput);
    document.getElementById('parentCategoryId').addEventListener('change', validateSubcategoryInput);
    document.getElementById('subcatId').addEventListener('input', validateSubcategoryInput);
    document.getElementById('subcatNameEng').addEventListener('input', validateSubcategoryInput);
    document.getElementById('prodId').addEventListener('input', validateProductInput);
    document.getElementById('prodNameEng').addEventListener('input', validateProductInput);


    // --- FORM SUBMISSION ---
    document.querySelectorAll('.modal-form').forEach(form => {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitButton = form.querySelector('.modal-submit-btn');
            const collectionName = form.dataset.collection;
            const editId = form.querySelector('input[name="editId"]').value;
            submitButton.disabled = true;
            submitButton.textContent = 'Saving...';

            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            for (let key in data) {
                if (key.startsWith('original') || key === 'editId' || key === 'parentCatId') {
                    delete data[key];
                }
            }
            if (collectionName === 'products') data.isTopProduct = 'isTopProduct' in data;

            try {
                if (editId) { // UPDATE
                    if (collectionName === 'categories') {
                        await update(ref(db, `categories/${editId}`), data);
                    } else if (collectionName === 'subcategories') {
                        const originalParentId = form.querySelector('input[name="parentCatId"]').value;
                        const newParentId = formData.get('parentCategoryId');
                        delete data.parentCategoryId;

                        if (originalParentId !== newParentId) {
                            const subcategoryData = (await get(ref(db, `categories/${originalParentId}/subcategories/${editId}`))).val();
                            const updates = {};
                            updates[`/categories/${originalParentId}/subcategories/${editId}`] = null;
                            updates[`/categories/${newParentId}/subcategories/${editId}`] = { ...subcategoryData, ...data };
                            await update(ref(db), updates);
                        } else {
                            await update(ref(db, `categories/${originalParentId}/subcategories/${editId}`), data);
                        }
                    } else if (collectionName === 'products') {
                        await update(ref(db, `products/${editId}`), data);
                    }
                    showToast('Item updated successfully!', 'success');
                } else { // ADD
                    let pathRef;
                    if (collectionName === 'subcategories') {
                        pathRef = ref(db, `categories/${data.parentCategoryId}/subcategories`);
                        delete data.parentCategoryId;
                    } else {
                        pathRef = ref(db, collectionName);
                    }
                    await set(push(pathRef), data);
                    showToast('Item added successfully!', 'success');
                }
                const modal = form.closest('.modal');
                modal.style.display = 'none';
                resetModal(modal);
            } catch (error) {
                console.error("Error saving data:", error);
                showToast(`Failed to save: ${error.message}`, 'error');
            } finally {
                submitButton.disabled = false;
            }
        });
    });

    // --- EVENT LISTENER FOR DELETE & EDIT ---
    document.querySelector('.main-content').addEventListener('click', async (e) => {
        const deleteButton = e.target.closest('.btn-delete');
        const editButton = e.target.closest('.btn-edit');

        if (deleteButton) {
            deleteButton.disabled = true;
            const itemId = deleteButton.dataset.id;
            const collectionName = deleteButton.dataset.collection;

            if (collectionName === 'categories') {
                const dependentSubcategories = allData.subcategories.filter(sub => sub.parentCategoryId === itemId);
                const dependentProducts = allData.products.filter(prod => prod.prodCategoryId === itemId);

                if (dependentSubcategories.length > 0 || dependentProducts.length > 0) {
                    alert(`Cannot delete this category because it contains other items.\n\n- Subcategories: ${dependentSubcategories.length}\n- Products: ${dependentProducts.length}\n\nPlease delete all associated items first.`);
                    deleteButton.disabled = false;
                    return;
                }
            }

            if (collectionName === 'subcategories') {
                const dependentProducts = allData.products.filter(prod => prod.prodSubCategoryId === itemId);
                if (dependentProducts.length > 0) {
                    alert(`Cannot delete this subcategory because it is linked to ${dependentProducts.length} products.\n\nPlease delete or move these products first.`);
                    deleteButton.disabled = false;
                    return;
                }
            }

            if (confirm(`Are you sure you want to delete this ${collectionName.slice(0, -1)}?`)) {
                try {
                    const parentId = deleteButton.dataset.parentId;
                    const itemRef = collectionName === 'subcategories'
                        ? ref(db, `categories/${parentId}/subcategories/${itemId}`)
                        : ref(db, `${collectionName}/${itemId}`);
                    await remove(itemRef);
                    showToast('Item deleted successfully!', 'success');
                } catch (error) {
                    showToast(`Error deleting item: ${error.message}`, 'error');
                }
            }
            deleteButton.disabled = false;
        }

        if (editButton) {
            const { id, collection } = editButton.dataset;
            let item;
            let modal;

            if (collection === 'categories') {
                item = allData.categories.find(c => c.id === id);
                modal = document.getElementById('categoryModal');
                const form = modal.querySelector('form');
                form.catId.value = item.catId;
                form.catNameEng.value = item.catNameEng;
                form.catNameTam.value = item.catNameTam;
                form.catImage.value = item.catImage;
                form.originalCatId.value = item.catId;
                form.originalCatNameEng.value = item.catNameEng;
            } else if (collection === 'subcategories') {
                item = allData.subcategories.find(s => s.id === id);
                modal = document.getElementById('subcategoryModal');
                const form = modal.querySelector('form');
                populateCategoryDropdowns();
                form.parentCategoryId.value = item.parentCategoryId;
                form.subcatId.value = item.subcatId;
                form.subcatNameEng.value = item.subcatNameEng;
                form.subcatNameTam.value = item.subcatNameTam;
                form.parentCatId.value = item.parentCategoryId;
                form.originalSubcatId.value = item.subcatId;
                form.originalSubcatNameEng.value = item.subcatNameEng;
            } else if (collection === 'products') {
                item = allData.products.find(p => p.id === id);
                modal = document.getElementById('productModal');
                const form = modal.querySelector('form');
                populateCategoryDropdowns();
                form.prodCategory.value = item.prodCategoryId;
                populateSubcategoryDropdown(item.prodCategoryId, 'prodSubCategory', item.prodSubCategoryId);
                form.prodId.value = item.prodId;
                form.prodNameEng.value = item.prodNameEng;
                form.prodNameTam.value = item.prodNameTam;
                form.prodRate.value = item.prodRate;
                form.isTopProduct.checked = item.isTopProduct || false;
                form.originalProdId.value = item.prodId;
                form.originalProdNameEng.value = item.prodNameEng;
            }

            if (item && modal) {
                const form = modal.querySelector('form');
                modal.querySelector('.modal-title').textContent = `Edit ${collection.slice(0, -1)}`;
                modal.querySelector('.modal-submit-btn').textContent = 'Update';
                form.editId.value = item.id;
                modal.style.display = 'flex';
                const submitButton = form.querySelector('.modal-submit-btn');
                if (submitButton) submitButton.disabled = false;
            } else {
                showToast('Could not find item to edit.', 'error');
            }
        }
    });

    // --- Page Load and UI ---
    document.getElementById('preloader').style.display = 'none';
    document.getElementById('enterDashboardBtn').addEventListener('click', () => {
        const frontPage = document.getElementById('frontPage');
        frontPage.style.opacity = '0';
        setTimeout(() => { frontPage.style.display = 'none'; }, 800);
    });
    document.getElementById('menuBtn').addEventListener('click', () => document.getElementById('sidebar').classList.toggle('show'));

</script>
</body>
</html>
